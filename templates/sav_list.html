{% extends 'base.html' %}
{% block title %}Liste des tâches SAV - Robot Monitoring{% endblock %}
{% load static %}

{% block content_wrapper %}
<div class="sav-list-container">
    <h2>Liste des tâches SAV</h2>
    
    <div class="sav-filters">
        <select id="priority-filter">
            <option value="all">Toutes les priorités</option>
            <option value="low">Basse</option>
            <option value="medium">Moyenne</option>
            <option value="high">Haute</option>
            <option value="urgent">Urgente</option>
        </select>
        
        <button id="apply-filters" class="filter-btn">Filtrer</button>
    </div>
    
    <div class="sav-kanban-board">
        <!-- Colonne "À faire" -->
        <div class="sav-column pending-column">
            <div class="column-header">
                <h3>À faire</h3>
                <span class="task-count">{{ pending_tasks|length }}</span>
            </div>
            <div class="column-tasks">
                {% for task in pending_tasks %}
                    <div class="sav-task-card priority-{{ task.priority }} status-{{ task.status }}">
                        <div class="task-header">
                            <h3>{{ task.title }}</h3>
                            <div class="task-badges">
                                <span class="priority-badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                            </div>
                        </div>
                        <div class="task-host">Hôte: {{ task.host }}</div>
                        <div class="task-dates">
                            <div>Créée le: {{ task.created_at|date:"d/m/Y H:i" }}</div>
                            <div>Mise à jour: {{ task.updated_at|date:"d/m/Y H:i" }}</div>
                        </div>
                        <div class="task-actions">
                            <a href="{% url 'sav_detail' task_id=task.id %}" class="view-task-btn">Voir détails</a>
                            <a href="{% url 'host_detail' host=task.host %}" class="view-host-btn">Voir l'hôte</a>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-column-message">
                        <p>Aucune tâche à faire</p>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Colonne "En cours" -->
        <div class="sav-column in-progress-column">
            <div class="column-header">
                <h3>En cours</h3>
                <span class="task-count">{{ in_progress_tasks|length }}</span>
            </div>
            <div class="column-tasks">
                {% for task in in_progress_tasks %}
                    <div class="sav-task-card priority-{{ task.priority }} status-{{ task.status }}">
                        <div class="task-header">
                            <h3>{{ task.title }}</h3>
                            <div class="task-badges">
                                <span class="priority-badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                            </div>
                        </div>
                        <div class="task-host">Hôte: {{ task.host }}</div>
                        <div class="task-dates">
                            <div>Créée le: {{ task.created_at|date:"d/m/Y H:i" }}</div>
                            <div>Mise à jour: {{ task.updated_at|date:"d/m/Y H:i" }}</div>
                        </div>
                        <div class="task-actions">
                            <a href="{% url 'sav_detail' task_id=task.id %}" class="view-task-btn">Voir détails</a>
                            <a href="{% url 'host_detail' host=task.host %}" class="view-host-btn">Voir l'hôte</a>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-column-message">
                        <p>Aucune tâche en cours</p>
                    </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Colonne "Terminé" -->
        <div class="sav-column completed-column">
            <div class="column-header">
                <h3>Terminé</h3>
                <span class="task-count">{{ completed_tasks|length }}</span>
            </div>
            <div class="column-tasks">
                {% for task in completed_tasks %}
                    <div class="sav-task-card priority-{{ task.priority }} status-{{ task.status }}">
                        <div class="task-header">
                            <h3>{{ task.title }}</h3>
                            <div class="task-badges">
                                <span class="priority-badge priority-{{ task.priority }}">{{ task.get_priority_display }}</span>
                            </div>
                        </div>
                        <div class="task-host">Hôte: {{ task.host }}</div>
                        <div class="task-dates">
                            <div>Créée le: {{ task.created_at|date:"d/m/Y H:i" }}</div>
                            <div>Mise à jour: {{ task.updated_at|date:"d/m/Y H:i" }}</div>
                        </div>
                        <div class="task-actions">
                            <a href="{% url 'sav_detail' task_id=task.id %}" class="view-task-btn">Voir détails</a>
                            <a href="{% url 'host_detail' host=task.host %}" class="view-host-btn">Voir l'hôte</a>
                        </div>
                    </div>
                {% empty %}
                    <div class="empty-column-message">
                        <p>Aucune tâche terminée</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    // Script pour le filtrage des tâches par priorité
    document.getElementById('apply-filters').addEventListener('click', function() {
        const priorityFilter = document.getElementById('priority-filter').value;
        
        const taskCards = document.querySelectorAll('.sav-task-card');
        
        taskCards.forEach(card => {
            let showByPriority = priorityFilter === 'all' || card.classList.contains('priority-' + priorityFilter);
            
            if (showByPriority) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
        
        // Vérifier si les colonnes sont vides après filtrage
        document.querySelectorAll('.column-tasks').forEach(column => {
            const visibleTasks = column.querySelectorAll('.sav-task-card[style="display: block"]').length;
            const emptyMessage = column.querySelector('.empty-column-message');
            
            if (visibleTasks === 0 && !emptyMessage) {
                const newEmptyMessage = document.createElement('div');
                newEmptyMessage.className = 'empty-column-message filtered';
                newEmptyMessage.innerHTML = '<p>Aucune tâche correspondante</p>';
                column.appendChild(newEmptyMessage);
            } else if (visibleTasks > 0 && emptyMessage && emptyMessage.classList.contains('filtered')) {
                emptyMessage.remove();
            }
        });
    });
</script>
{% endblock %}